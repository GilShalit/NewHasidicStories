@page "/Story/{fileName}/{storyId}"
@using Microsoft.Extensions.Localization
@using System.Text.Json
@inject IStringLocalizer<Story> Localizer
@inject IJSRuntime JS
@inject IConfiguration Configuration

<div class="controlsContainer">
    <Row>
        <Column ColumnSize="@Column1Size">
            <Row >
                <StoryThemes caption="@Localizer["themes"]" />
            </Row>
            <Row Margin="Margin.Is2.FromTop">
                <StoryPeople caption="@Localizer["people"]" />
            </Row>
            <Row Margin="Margin.Is2.FromTop">
                <StoryPlaces caption="@Localizer["places"]" />
            </Row>
        </Column>
        <Column ColumnSize="@Column2Size" Style="direction:rtl">
            <StoryTEI fileName="@fileName" storyId="@storyId" />
        </Column>
        @if (showMap)
        {
            <Column ColumnSize="@Column3Size">
                <StoryMap />
            </Column>
        }
    </Row>
</div>

@code {
    [Inject] GlobalService globalService { get; set; }
    [Parameter] public string fileName { get; set; }
    [Parameter] public string storyId { get; set; }
    private Blazorise.IFluentColumn Column1Size, Column2Size, Column3Size;
    private bool showMap;

    protected override async Task OnInitializedAsync()
    {
        var stateJson = await JS.InvokeAsync<string>("localStorage.getItem", "places");
        if (!string.IsNullOrEmpty(stateJson))
        {
            clsPlaces places = JsonSerializer.Deserialize<clsPlaces>(stateJson, new JsonSerializerOptions { IncludeFields = true });

            showMap = places.Count > 0;
            if (showMap)
            {
                Column1Size = ColumnSize.Is2;
                Column2Size = ColumnSize.Is6;
                Column3Size = ColumnSize.Is4;
                foreach (clsPlace place in places)
                {
                    place.selected = true;
                }
            }
            else {
                Column1Size = ColumnSize.Is3;
                Column2Size = ColumnSize.Is9;
            }

            globalService.Places = places;

            globalService.Points = JsonSerializer.Deserialize<clsGeoJson>(await JS.InvokeAsync<string>("localStorage.getItem", "points"), new JsonSerializerOptions { IncludeFields = true });
            globalService.Themes = JsonSerializer.Deserialize<clsThemes>(await JS.InvokeAsync<string>("localStorage.getItem", "themes"), new JsonSerializerOptions { IncludeFields = true });
            globalService.Persons = JsonSerializer.Deserialize<clsPersons>(await JS.InvokeAsync<string>("localStorage.getItem", "people"), new JsonSerializerOptions { IncludeFields = true });
        }
    }
    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (!firstRender)
    //     {
    //         globalService.Persons = new clsPersons();//temporary, just to fire the OnGlobalPersonsChanged event
    //     }
    // }

}
